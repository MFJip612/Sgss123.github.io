---
import BaseHead from "../components/BaseHead.astro";
import Footer from "../components/Footer.astro";
import Header from "../components/Header.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from "../consts";

import Turnstile from "../components/Turnstile.vue";
---

<!doctype html>
<html lang="en">
    <head>
        <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
        <link
            rel="stylesheet"
            href="https://static.im-a.gay/plugins/XP.css-0.2.6/dist/XP.css"
        />
        <style>
            .main-body {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
            }
            .error-message {
                color: red;
                font-size: 12px;
                margin-top: 4px;
                display: none;
            }
            .field-row.error input {
                border: 1px solid red;
            }
        </style>
    </head>
    <body>
        <Header />
        <main>
            <!-- 上下左右居中 -->
            <div class="window system-main">
                <div class="title-bar">
                    <div class="title-bar-text">QSL签收系统</div>
                </div>
                <div class="window-body main-body">
                    <form id="qslForm" action="">
                        <div class="field-row" id="qslCodeField">
                            <label for="qslCode"
                                >请填写QSL卡片上的唯一编码：</label
                            >
                            <input
                                id="qslCode"
                                type="text"
                                placeholder="QSL-XXXXX-XXX"
                                maxlength="13"
                                required
                            />
                            <div class="error-message" id="errorMessage">
                                请输入正确的格式：QSL-XXXXX-XXX（X为字母或数字）
                            </div>
                        </div>
                        <div
                            class="field-row cf-turnstile"
                            data-sitekey="0x4AAAAAABkS4AjGy6vPeTBH"
                            data-callback="onTurnstileSuccess"
                            data-expired-callback="onTurnstileExpired"
                            data-error-callback="onTurnstileError">
                        </div>
                        <section
                            class="field-row"
                            style="justify-content: flex-end">
                            <button type="submit" id="submitBtn" disabled>Submit</button>
                            <button type="reset" id="resetBtn">Reset</button>
                        </section>
                    </form>
                </div>
            </div>
        </main>
        <Footer />
        <script
            is:inline
            src="https://challenges.cloudflare.com/turnstile/v0/api.js"
            async
            defer></script>
        <script is:inline>
            let turnstileCompleted = false;
            let inputValid = false;

            // QSL代码格式验证
            function validateQSLCode(code) {
                const pattern = /^QSL-[A-Z0-9]{5}-[A-Z0-9]{3}$/i;
                return pattern.test(code);
            }

            // 更新提交按钮状态
            function updateSubmitButton() {
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = !(turnstileCompleted && inputValid);
            }

            // Turnstile回调函数
            window.onTurnstileSuccess = function(token) {
                turnstileCompleted = true;
                updateSubmitButton();
            };

            window.onTurnstileExpired = function() {
                turnstileCompleted = false;
                updateSubmitButton();
            };

            window.onTurnstileError = function() {
                turnstileCompleted = false;
                updateSubmitButton();
            };

            // 页面加载完成后初始化
            document.addEventListener('DOMContentLoaded', function() {
                const qslCodeInput = document.getElementById('qslCode');
                const errorMessage = document.getElementById('errorMessage');
                const qslCodeField = document.getElementById('qslCodeField');
                const form = document.getElementById('qslForm');
                const resetBtn = document.getElementById('resetBtn');

                // 输入验证
                qslCodeInput.addEventListener('input', function() {
                    const value = this.value.trim();
                    
                    if (value === '') {
                        inputValid = false;
                        qslCodeField.classList.remove('error');
                        errorMessage.style.display = 'none';
                    } else if (validateQSLCode(value)) {
                        inputValid = true;
                        qslCodeField.classList.remove('error');
                        errorMessage.style.display = 'none';
                    } else {
                        inputValid = false;
                        qslCodeField.classList.add('error');
                        errorMessage.style.display = 'block';
                    }
                    
                    updateSubmitButton();
                });

                // 表单提交验证
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const qslCode = qslCodeInput.value.trim();
                    
                    if (!validateQSLCode(qslCode)) {
                        alert('请输入正确的QSL代码格式');
                        return;
                    }
                    
                    if (!turnstileCompleted) {
                        alert('请完成人机验证');
                        return;
                    }
                    
                    // 这里可以添加实际的提交逻辑
                    console.log('QSL代码：', qslCode);
                    alert('提交成功！');
                });

                // 重置按钮功能
                resetBtn.addEventListener('click', function() {
                    inputValid = false;
                    turnstileCompleted = false;
                    qslCodeField.classList.remove('error');
                    errorMessage.style.display = 'none';
                    updateSubmitButton();
                    
                    // 重置Turnstile
                    if (window.turnstile) {
                        window.turnstile.reset();
                    }
                });

                // 初始化按钮状态
                updateSubmitButton();
            });
        </script>
    </body>
</html>
